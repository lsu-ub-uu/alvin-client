from datetime import datetime
from django.core.paginator import Paginator, EmptyPage
from django.shortcuts import render
from django.utils import timezone
from django.views.decorators.csrf import csrf_exempt

import requests
from lxml import etree
import urllib.request
from urllib.request import urlopen
parser = etree.XMLParser()

def search(request):

    xml_headers_list = {'Content-Type':'application/vnd.cora.recordList-decorated+xml','Accept':'application/vnd.cora.recordList-decorated+xml'}
            

    params = request.POST.copy() if request.method == "POST" else request.GET.copy()

    errors = []
    verb = None
    identifier = None
    metadata_prefix = None
    set_spec = None
    from_timestamp = None
    until_timestamp = None
    resumption_token = None



        elif verb == "ListIdentifiers":
            template = "django_oai_pmh/listidentifiers.xml"              
            set = request.GET.get('set', '*')
            metadata_prefix = request.GET.get('metadataPrefix')
            start = request.GET.get('start', 1)         
            rows = request.GET.get('rows', 100)
            newstart = start + rows
                               
            list_url = f'https://cora.alvin-portal.org/rest/record/searchResult/alvinRecordSearch?searchData={{"name":"alvinRecordSearch","children":[{{"name":"include","children":[{{"name":"includePart","children":[{{"name":"permissionUnitSearchTerm","value":"permissionUnit_{set}"}}]}}]}},{{"name":"start","value":"{start}"}},{{"name":"rows","value":"{rows}"}}]}}'
            response = requests.get(list_url, headers=xml_headers_list)
            if response.status_code == 200:
                xml_list = etree.fromstring(response.content)         
                records = []
                for record in xml_list.findall('data/record/data/record'):
                    records.append({
                      'identifier': record.findtext('./recordInfo/id'),
                      'datestamp': record.findtext('./recordInfo/updated/tsUpdated[last()]'),
         	      'setSpec': record.findtext('./physicalLocation/heldBy/location/linkedRecordId'),
                       })
            else:
                records = 0
            pages = {
                "fromNo":xml_list.findtext(".//fromNo"),
                "toNo":xml_list.findtext(".//toNo"),
                "totalNo":xml_list.findtext(".//totalNo"),
                }
            totalNo = pages.get("totalNo")          
            completeListSize = int(totalNo)
            toNo = pages.get("toNo")          
            cursor = int(toNo) 
            if cursor < completeListSize and not "resumptionToken" in params: 
                metadata_prefix = request.GET.get('metadataPrefix')
                set = request.GET.get('set','')
                newstart = start + rows
                num = int(newstart)
                resumptionToken = f"{metadata_prefix}/{set}/{num}"                
            if "resumptionToken" in params:
                if not records:
                    errors.append(_error("badResumptionToken_resumptionToken"))                        
            elif "metadataPrefix" in params:
                metadata_prefix = params.pop("metadataPrefix")
                if len(metadata_prefix) == 1:
                    metadata_prefix = metadata_prefix[0]
                    prefix_url = f'https://cora.alvin-portal.org/rest/record/metadata/{metadata_prefix}Item'
                    response = requests.get(prefix_url)
                    if response.status_code != 200:
                        errors.append(
                             _error("cannotDisseminateFormat", metadata_prefix)
                        )
                    else:                      
                        if "set" in params:
                            set_url = f'https://cora.alvin-portal.org/rest/record/alvin-location/{set}'
                            response = requests.get(set_url)
                            set_spec = params.pop("set")[-1]
                            if response.status_code != 200:
                                errors.append(_error("badArgument_set"))                             
                        from_timestamp, until_timestamp = _check_timestamps(
                            params, errors
                        )
                        if from_timestamp:
                            header_list = header_list.filter(
                                timestamp__gte=from_timestamp
                            )
                        if until_timestamp:
                            header_list = header_list.filter(
                                timestamp__lte=until_timestamp
                            )
                        if not records and not errors:
                            errors.append(_error("noRecordsMatch"))
                else:
                    errors.append(
                        _error("badArgument_single", ";".join(metadata_prefix))
                    )
                    metadata_prefix = None
            else:
               errors.append(_error("badArgument", "metadataPrefix"))
            _check_bad_arguments(params, errors)

    return render(
        request,
        template if not errors else "django_oai_pmh/error.xml",
        locals(),
        content_type="text/xml",
    )


https://cora.alvin-portal.org/rest/record/searchResult/personSearch?searchData=%7B%22name%22%3A%22personSearch%22%2C%22children%22%3A%5B%7B%22name%22%3A%22include%22%2C%22children%22%3A%5B%7B%22name%22%3A%22includePart%22%2C%22children%22%3A%5B%7B%22name%22%3A%22personSearchTerm%22%2C%22value%22%3A%22**%22%7D%5D%7D%5D%7D%2C%7B%22name%22%3A%22start%22%2C%22value%22%3A%221%22%7D%2C%7B%22name%22%3A%22rows%22%2C%22value%22%3A%2220%22%7D%5D%7D

https://cora.alvin-portal.org/rest/record/searchResult/alvinRecordSearch?searchData={"name":"alvinRecordSearch","children":[{"name":"include","children":[{"name":"includePart","children":[{"name":"alvinRecordSearchTerm","value":"**"}]}]},{"name":"start","value":"1"}]}


https://cora.alvin-portal.org/rest/record/searchResult/personSearch?searchData={{"name":"personSearch","children":[{{"name":"include","children":[{{"name":"includePart","children":[{{"name":"personSearchTerm","value":"**"}}]}}]}},{{"name":"start","value":"1"}},{{"name":"rows","value":"20"}}]}}


https://cora.alvin-portal.org/rest/record/searchResult/organisationSearch?searchData={"name":"organisationSearch","children":[{"name":"include","children":[{"name":"includePart","children":[{"name":"organisationSearchTerm","value":"**"}]}]},{"name":"start","value":"1"},{"name":"rows","value":"20"}]}